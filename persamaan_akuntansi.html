<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Akuntansi Profesional </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #475569; font-weight: 500; transition: all 0.2s ease-in-out; }
        .nav-link:hover { background-color: #e2e8f0; color: #1e293b; }
        .nav-link.active { background-color: #4f46e5; color: white; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        #sidebar { transition: transform 0.3s ease-in-out; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Gaya untuk Tab Buku Besar */
        .ledger-tabs-container {
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .ledger-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            font-weight: 600;
            color: #475569;
            transition: all 0.2s;
        }
        .ledger-tab:hover { color: #1e293b; }
        .ledger-tab.active {
            color: #4f46e5;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="relative min-h-screen lg:flex">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

        <aside id="sidebar" class="bg-white w-64 fixed inset-y-0 left-0 z-30 flex-shrink-0 flex flex-col border-r border-slate-200 transform -translate-x-full lg:translate-x-0 lg:relative">
            <div class="h-16 flex items-center justify-center border-b border-slate-200 px-4 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <i data-feather="book" class="text-indigo-600"></i>
                    <h1 class="text-xl font-bold text-slate-800">AkuntansiYak</h1>
                </div>
            </div>
            <div class="p-4 flex-grow overflow-y-auto">
                <button id="new-transaction-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-indigo-700 transition-colors shadow-sm">
                    <i data-feather="plus-circle" class="w-5 h-5"></i>
                    <span>Transaksi Baru</span>
                </button>
                <nav class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Laporan</h3>
                    <ul class="space-y-1" id="nav-links">
                        <li><a href="#" class="nav-link active" data-view="persamaan-akuntansi"><i data-feather="grid"></i><span>Persamaan Akuntansi</span></a></li>
                        <li><a href="#" class="nav-link" data-view="laba-rugi"><i data-feather="trending-up"></i><span>Laba Rugi</span></a></li>
                        <li><a href="#" class="nav-link" data-view="perubahan-modal"><i data-feather="layers"></i><span>Perubahan Modal</span></a></li>
                        <li><a href="#" class="nav-link" data-view="neraca"><i data-feather="briefcase"></i><span>Neraca</span></a></li>
                    </ul>
                     <h3 class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Buku & Jurnal</h3>
                     <ul class="space-y-1" id="nav-links-2">
                        <li><a href="#" class="nav-link" data-view="jurnal-umum"><i data-feather="file-text"></i><span>Jurnal Umum</span></a></li>
                        <li><a href="#" class="nav-link" data-view="buku-besar"><i data-feather="book-open"></i><span>Buku Besar</span></a></li>
                        <li><a href="#" class="nav-link" data-view="neraca-saldo"><i data-feather="check-square"></i><span>Neraca Saldo</span></a></li>
                    </ul>
                </nav>
            </div>
            <footer class="text-center p-4 border-t border-slate-200 flex-shrink-0">
                <p class="text-xs text-slate-500">
                    Oleh <a href="https://www.instagram.com/its_eyak/" target="_blank" rel="noopener noreferrer" class="font-semibold text-indigo-600 hover:text-indigo-800">its_eyak</a>
                </p>
            </footer>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 lg:hidden sticky top-0 z-10">
                <button id="menu-btn" class="p-2 text-slate-600 hover:text-slate-900">
                    <i data-feather="menu" class="w-6 h-6"></i>
                </button>
                 <div class="flex items-center gap-2">
                    <i data-feather="book" class="text-indigo-600"></i>
                    <h1 class="text-xl font-bold text-slate-800">AkuntansiPro</h1>
                </div>
                <div class="w-10"></div> </header>
            <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
                <div id="view-persamaan-akuntansi" class="view"></div>
                <div id="view-laba-rugi" class="view hidden"></div>
                <div id="view-perubahan-modal" class="view hidden"></div>
                <div id="view-neraca" class="view hidden"></div>
                <div id="view-jurnal-umum" class="view hidden"></div>
                <div id="view-buku-besar" class="view hidden"></div>
                <div id="view-neraca-saldo" class="view hidden"></div>
            </main>
        </div>
    </div>

    <div id="transaction-modal" class="modal fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content card w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95">
             <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-slate-800">Formulir Transaksi</h2>
                    <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="transaction-form" class="space-y-4">
                    <input type="hidden" id="transaction-id">
                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-600 mb-1">Tanggal</label>
                        <input type="date" id="date" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                     <div>
                        <label for="transaction-type" class="block text-sm font-medium text-slate-600 mb-1">Jenis Transaksi</label>
                        <select id="transaction-type" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            <option value="" disabled selected>-- Pilih Jenis Transaksi --</option>
                            <optgroup label="Modal & Aset">
                                <option value="setoran-pemilik">Setoran Modal Pemilik</option>
                                <option value="beli-aset-tunai">Pembelian Aset (Tunai)</option>
                                <option value="beli-aset-kredit">Pembelian Aset (Kredit)</option>
                                <option value="prive">Prive (Penarikan Modal)</option>
                            </optgroup>
                            <optgroup label="Pendapatan & Piutang">
                                <option value="pendapatan-tunai">Terima Pendapatan (Tunai)</option>
                                <option value="pendapatan-kredit">Pendapatan (Kredit/Piutang)</option>
                                <option value="terima-piutang">Penerimaan Piutang</option>
                            </optgroup>
                             <optgroup label="Beban & Utang">
                                <option value="bayar-beban">Pembayaran Beban</option>
                                <option value="terima-pinjaman">Terima Pinjaman/Utang</option>
                                <option value="bayar-utang">Pembayaran Utang</option>
                            </optgroup>
                            <optgroup label="Penyesuaian">
                                <option value="pakai-perlengkapan">Pemakaian Perlengkapan</option>
                                <option value="penyusutan-peralatan">Penyusutan Peralatan</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-600 mb-1">Keterangan</label>
                        <input type="text" id="description" placeholder="Contoh: Jasa desain untuk PT Maju" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    
                    <div id="expense-type-container" class="hidden">
                        <label for="expense-type-select" class="block text-sm font-medium text-slate-600 mb-1">Pilih Jenis Beban</label>
                        <select id="expense-type-select" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                    </div>
                    
                    <div id="cash-container">
                        <label for="amount-cash" class="block text-sm font-medium text-slate-600 mb-1">Jumlah (Rp)</label>
                        <input type="text" inputmode="numeric" id="amount-cash" placeholder="0" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div id="asset-purchase-container" class="hidden space-y-2 border-t pt-3 mt-3">
                         <label class="block text-sm font-bold text-slate-700">Detail Pembelian Aset</label>
                        <div>
                            <label for="amount-perlengkapan-beli" class="block text-sm font-medium text-slate-600 mb-1">Nilai Perlengkapan (Rp)</label>
                            <input type="text" inputmode="numeric" id="amount-perlengkapan-beli" placeholder="0" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="amount-peralatan-beli" class="block text-sm font-medium text-slate-600 mb-1">Nilai Peralatan (Rp)</label>
                            <input type="text" inputmode="numeric" id="amount-peralatan-beli" placeholder="0" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div id="asset-investment-container" class="hidden space-y-2 border-t pt-3 mt-3">
                        <label class="block text-sm font-bold text-slate-700">Detail Aset Investasi</label>
                        <div class="flex items-center space-x-2">
                              <label for="amount-cash-inv" class="w-24 text-sm font-medium text-slate-600">Tunai:</label>
                              <input type="text" inputmode="numeric" id="amount-cash-inv" placeholder="0" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center space-x-2">
                              <label for="amount-perlengkapan-inv" class="w-24 text-sm font-medium text-slate-600">Perlengkapan:</label>
                              <input type="text" inputmode="numeric" id="amount-perlengkapan-inv" placeholder="0" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center space-x-2">
                              <label for="amount-peralatan-inv" class="w-24 text-sm font-medium text-slate-600">Peralatan:</label>
                              <input type="text" inputmode="numeric" id="amount-peralatan-inv" placeholder="0" class="block w-full border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-3 border-t">
                        <button type="button" id="cancel-form-btn" class="w-full bg-slate-200 text-slate-800 font-medium py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors"><span>Batal</span></button>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors"><span>Simpan Transaksi</span></button>
                    </div>
                </form>
             </div>
        </div>
    </div>
    
<script>
// --- SCRIPT UTAMA APLIKASI ---
document.addEventListener('DOMContentLoaded', () => {
    // --- Definisi Akun (Chart of Accounts) ---
    const ACCOUNTS = {
        '101': { name: 'Kas', eq_group: 'kas' },
        '102': { name: 'Piutang Usaha', eq_group: 'piutang' },
        '103': { name: 'Perlengkapan', eq_group: 'perlengkapan' },
        '121': { name: 'Peralatan', eq_group: 'peralatan' },
        '122': { name: 'Akum. Peny. Peralatan', eq_group: 'peralatan', isContra: true },
        '201': { name: 'Utang Usaha', eq_group: 'utang' },
        '301': { name: 'Modal Pemilik', eq_group: 'modal' },
        '302': { name: 'Prive', eq_group: 'modal', isContra: true },
        '401': { name: 'Pendapatan Jasa', eq_group: 'modal', isIncome: true },
        '501': { name: 'Beban Gaji', eq_group: 'modal', isExpense: true },
        '502': { name: 'Beban Sewa', eq_group: 'modal', isExpense: true },
        '503': { name: 'Beban Listrik & Air', eq_group: 'modal', isExpense: true },
        '504': { name: 'Beban Iklan', eq_group: 'modal', isExpense: true },
        '505': { name: 'Beban Perlengkapan', eq_group: 'modal', isExpense: true },
        '506': { name: 'Beban Penyusutan', eq_group: 'modal', isExpense: true },
        '599': { name: 'Beban Lain-lain', eq_group: 'modal', isExpense: true }
    };
    const getAccountType = (id) => (['Aset','Liabilitas','Ekuitas','Pendapatan','Beban'][id[0]-1] || 'Lainnya');
    
    // --- Elemen DOM ---
    const form = document.getElementById('transaction-form');
    const allAmountInputs = Array.from(document.querySelectorAll('input[type="text"][inputmode="numeric"]'));
    const modal = document.getElementById('transaction-modal');
    const newTransactionBtn = document.getElementById('new-transaction-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelFormBtn = document.getElementById('cancel-form-btn');
    const menuBtn = document.getElementById('menu-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const expenseTypeContainer = document.getElementById('expense-type-container');
    const expenseTypeSelect = document.getElementById('expense-type-select');

    // --- Penyimpanan Data ---
    let transactions = JSON.parse(localStorage.getItem('accounting_transactions_v14')) || [];

    // --- Fungsi Utilitas ---
    const parseCurrency = (v) => parseFloat(String(v).replace(/\./g, '')) || 0;
    const formatCurrency = (a, rp = false) => `${rp ? 'Rp ' : ''}${new Intl.NumberFormat('id-ID').format(a)}`;
    allAmountInputs.forEach(i => i.addEventListener('input', e => {
        const v = parseCurrency(e.target.value);
        e.target.value = v > 0 ? formatCurrency(v) : '';
    }));
    const resetForm = () => {
        form.reset();
        form.querySelector('#transaction-id').value = '';
        form.querySelector('#date').valueAsDate = new Date();
        document.getElementById('cash-container').classList.remove('hidden');
        document.getElementById('asset-purchase-container').classList.add('hidden');
        document.getElementById('asset-investment-container').classList.add('hidden');
        expenseTypeContainer.classList.add('hidden');
    };
    
    const populateExpenseSelect = () => {
        expenseTypeSelect.innerHTML = '';
        Object.entries(ACCOUNTS).forEach(([id, acc]) => {
            if (id.startsWith('5') && !['505', '506'].includes(id)) { // Exclude adjustment expenses
                const option = document.createElement('option');
                option.value = id;
                option.textContent = acc.name;
                expenseTypeSelect.appendChild(option);
            }
        });
    };

    // --- Logika Modal & Navigasi Mobile ---
    const openModal = () => { modal.classList.remove('opacity-0', 'pointer-events-none'); document.querySelector('.modal-content').classList.remove('scale-95'); };
    const closeModal = () => { modal.classList.add('opacity-0', 'pointer-events-none'); document.querySelector('.modal-content').classList.add('scale-95'); resetForm(); };
    const openSidebar = () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); };
    const closeSidebar = () => { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); };

    newTransactionBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    cancelFormBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e => e.target === modal && closeModal());
    menuBtn.addEventListener('click', openSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    // --- Event Listener Form ---
    document.getElementById('transaction-type').addEventListener('change', e => {
        const type = e.target.value;
        const currentData = { id: form.querySelector('#transaction-id').value, desc: form.querySelector('#description').value, date: form.querySelector('#date').value };
        resetForm();
        form.querySelector('#transaction-id').value = currentData.id;
        form.querySelector('#description').value = currentData.desc;
        form.querySelector('#date').value = currentData.date;
        form.querySelector('#transaction-type').value = type;
        
        const showAssetInv = type === 'setoran-pemilik';
        const showAssetPurch = ['beli-aset-tunai', 'beli-aset-kredit'].includes(type);
        const showExpenseSelect = type === 'bayar-beban';
        
        expenseTypeContainer.classList.toggle('hidden', !showExpenseSelect);
        document.getElementById('asset-investment-container').classList.toggle('hidden', !showAssetInv);
        document.getElementById('asset-purchase-container').classList.toggle('hidden', !showAssetPurch);
        document.getElementById('cash-container').classList.toggle('hidden', showAssetInv || showAssetPurch);
    });

    form.addEventListener('submit', e => {
        e.preventDefault();
        const getVal = id => parseCurrency(document.getElementById(id).value);
        const data = {
            id: form.querySelector('#transaction-id').value || Date.now().toString(),
            date: form.querySelector('#date').value,
            type: form.querySelector('#transaction-type').value,
            desc: form.querySelector('#description').value,
            expenseType: expenseTypeSelect.value,
            cash: getVal('amount-cash'), perlengkapanBeli: getVal('amount-perlengkapan-beli'), peralatanBeli: getVal('amount-peralatan-beli'),
            cashInv: getVal('amount-cash-inv'), perlengkapanInv: getVal('amount-perlengkapan-inv'), peralatanInv: getVal('amount-peralatan-inv')
        };

        if (!data.date || !data.desc || !data.type) return alert('Harap isi semua kolom utama.');
        
        let journalEntries = [], type = data.type, cash = data.cash, pBeli = data.perlengkapanBeli, rBeli = data.peralatanBeli, cInv = data.cashInv, pInv = data.perlengkapanInv, rInv = data.peralatanInv;
        const add = (acc, d, c) => journalEntries.push({accountId: acc, debit: d, credit: c});
        
        if(type==='setoran-pemilik'){ const t = cInv+pInv+rInv; if(cInv>0)add('101',cInv,0); if(pInv>0)add('103',pInv,0); if(rInv>0)add('121',rInv,0); if(t>0)add('301',0,t); }
        else if(type==='beli-aset-tunai'){ const t = pBeli+rBeli; if(pBeli>0)add('103',pBeli,0); if(rBeli>0)add('121',rBeli,0); if(t>0)add('101',0,t); }
        else if(type==='beli-aset-kredit'){ const t = pBeli+rBeli; if(pBeli>0)add('103',pBeli,0); if(rBeli>0)add('121',rBeli,0); if(t>0)add('201',0,t); }
        else if(type==='pendapatan-tunai'){ add('101',cash,0); add('401',0,cash); } else if(type==='pendapatan-kredit'){ add('102',cash,0); add('401',0,cash); }
        else if(type==='terima-piutang'){ add('101',cash,0); add('102',0,cash); } else if(type==='bayar-beban'){ add(data.expenseType,cash,0); add('101',0,cash); }
        else if(type==='terima-pinjaman'){ add('101',cash,0); add('201',0,cash); } else if(type==='bayar-utang'){ add('201',cash,0); add('101',0,cash); }
        else if(type==='prive'){ add('302',cash,0); add('101',0,cash); } else if(type==='pakai-perlengkapan'){ add('505',cash,0); add('103',0,cash); }
        else if(type==='penyusutan-peralatan'){ add('506',cash,0); add('122',0,cash); }

        const newTx = {id: data.id, date: data.date, type: data.type, description: data.desc, journalEntries, rawDetails: {amountCash:cash, expenseType:data.expenseType, amountPerlengkapanBeli:pBeli, amountPeralatanBeli:rBeli, amountCashInv:cInv, amountPerlengkapanInv:pInv, amountPeralatanInv:rInv}};
        const index = transactions.findIndex(tx => tx.id === data.id);
        if (index > -1) transactions[index] = newTx; else transactions.push(newTx);
        
        renderAll();
        closeModal();
    });

    // --- Fungsi Render Utama ---
    const renderAll = () => {
        transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
        const ledger = calculateLedger();
        renderEquationTable();
        renderGeneralJournal();
        renderGeneralLedger(ledger);
        renderTrialBalance(ledger);
        renderFinancialReports(ledger);
        localStorage.setItem('accounting_transactions_v14', JSON.stringify(transactions));
        feather.replace();
    };
    
    const renderCard = (viewId, title, content) => {
        document.getElementById(viewId).innerHTML = `<div class="card"><div class="p-4 md:p-5 border-b border-slate-200"><h2 class="text-lg md:text-xl font-bold text-slate-800">${title}</h2></div><div class="p-4 md:p-5">${content}</div></div>`;
    };
    const renderEmptyState = (viewId, title) => {
        renderCard(viewId, title, `<div class="text-center py-10 text-slate-500">Belum ada transaksi.</div>`);
    };

    // --- Render Tabel dengan Saldo Berjalan (Logika Diperbaiki) ---
    const renderEquationTable = () => {
        if (!transactions.length) return renderEmptyState('view-persamaan-akuntansi', 'Persamaan Akuntansi');
        
        const getChanges = tx => {
            let ch = { kas: 0, piutang: 0, perlengkapan: 0, peralatan: 0, utang: 0, modal: 0 };
            tx.journalEntries.forEach(e => {
                const acc = ACCOUNTS[e.accountId];
                const accType = getAccountType(e.accountId);
                let amount = e.debit - e.credit; // Debit is positive, Credit is negative

                if (acc.isContra || acc.isExpense) { // Prive & Beban (Debit+) -> mengurangi modal
                    ch[acc.eq_group] -= amount;
                } else if (acc.isIncome) { // Pendapatan (Credit-) -> dikurangi jadi +, menambah modal
                    ch[acc.eq_group] -= amount;
                } else { // Akun Aset, Liabilitas, Modal normal
                    if (accType === 'Aset') {
                        ch[acc.eq_group] += amount; // Aset: Debit +, Credit -
                    } else { // Liabilitas & Ekuitas
                        ch[acc.eq_group] -= amount; // L&E: Credit is -, dikurangi jadi +, menambah saldo
                    }
                }
            });
            return ch;
        };

        const actionButtons = id => `<div class="flex items-center justify-center"><button onclick="editTransaction('${id}')" title="Edit" class="text-slate-500 hover:text-indigo-600 p-1 rounded-full transition-colors"><i data-feather="edit-2" class="w-4 h-4"></i></button><button onclick="deleteTransaction('${id}')" title="Hapus" class="text-slate-500 hover:text-red-600 p-1 rounded-full transition-colors"><i data-feather="trash-2" class="w-4 h-4"></i></button></div>`;
        const valueCell = (v, isTotal = false) => `<td class="py-3 px-4 text-right whitespace-nowrap ${isTotal ? '' : (v > 0 ? 'text-green-600' : v < 0 ? 'text-red-600' : '')}">${v !== 0 ? formatCurrency(v) : '-'}</td>`;

        let runningTotals = { kas: 0, piutang: 0, perlengkapan: 0, peralatan: 0, utang: 0, modal: 0 };
        let tableBodyHTML = '';

        transactions.forEach(tx => {
            const changes = getChanges(tx);
            tableBodyHTML += `<tr class="hover:bg-slate-50 border-b"><td class="py-3 px-4 whitespace-nowrap sticky left-0 bg-white hover:bg-slate-50">${tx.date}</td>${valueCell(changes.kas)}${valueCell(changes.piutang)}${valueCell(changes.perlengkapan)}${valueCell(changes.peralatan)}${valueCell(changes.utang)}${valueCell(changes.modal)}<td class="py-3 px-4 text-slate-600 min-w-[200px]">${tx.description}</td><td class="py-3 px-4 text-center">${actionButtons(tx.id)}</td></tr>`;
            
            Object.keys(runningTotals).forEach(key => { runningTotals[key] += changes[key]; });
            
            tableBodyHTML += `<tr class="bg-slate-100 font-semibold text-slate-600 text-sm"><td class="py-2 px-4 italic sticky left-0 bg-slate-100">Saldo</td>${Object.values(runningTotals).map(val => `<td class="py-2 px-4 text-right">${formatCurrency(val)}</td>`).join('')}<td colspan="2"></td></tr>`;
        });
        
        const totalAset = runningTotals.kas + runningTotals.piutang + runningTotals.perlengkapan + runningTotals.peralatan;
        const totalPasiva = runningTotals.utang + runningTotals.modal;
        const isBalanced = Math.round(totalAset) === Math.round(totalPasiva);

        const table = `<div class="overflow-x-auto"><table class="w-full min-w-[950px] text-sm">
            <thead class="bg-slate-50 text-slate-600 uppercase text-xs">
                <tr>
                    <th rowspan="2" class="py-3 px-4 font-semibold sticky left-0 bg-slate-50 z-10">Tanggal</th>
                    <th colspan="4" class="py-3 px-4 text-center font-semibold border-l">Aset</th>
                    <th colspan="2" class="py-3 px-4 text-center font-semibold border-l">Liabilitas & Ekuitas</th>
                    <th rowspan="2" class="py-3 px-4 font-semibold border-l">Keterangan</th>
                    <th rowspan="2" class="py-3 px-4 font-semibold border-l">Aksi</th>
                </tr>
                <tr><th class="py-3 px-4 text-center font-semibold border-t border-l">Kas</th><th class="py-3 px-4 text-center font-semibold border-t border-l">Piutang</th><th class="py-3 px-4 text-center font-semibold border-t border-l">Perlengkapan</th><th class="py-3 px-4 text-center font-semibold border-t border-l">Peralatan</th><th class="py-3 px-4 text-center font-semibold border-t border-l">Utang</th><th class="py-3 px-4 text-center font-semibold border-t border-l">Modal</th></tr>
            </thead>
            <tbody class="bg-white">${tableBodyHTML}</tbody>
            <tfoot class="font-bold text-slate-800">
                <tr class="bg-slate-200"><td class="py-3 px-4 sticky left-0 bg-slate-200">Total Akhir</td>${Object.values(runningTotals).map(v => valueCell(v, true)).join('')}<td colspan="2"></td></tr>
                <tr class="${isBalanced ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    <td colspan="5" class="py-3 px-4 text-center">Total Aset: ${formatCurrency(totalAset, true)}</td>
                    <td colspan="4" class="py-3 px-4 text-center border-l">Total Liabilitas & Ekuitas: ${formatCurrency(totalPasiva, true)}</td>
                </tr>
            </tfoot>
            </table></div>`;

        renderCard('view-persamaan-akuntansi', 'Persamaan Akuntansi', table);
    };
    
    // --- Sisa Script (tidak ada perubahan) ---
    // (Kode di bawah ini sengaja disingkat untuk keringkasan, karena tidak ada perubahan dari versi sebelumnya)
    // Cukup salin seluruh blok <script> ini
    const fullScript = () => {
        renderGeneralJournal = () => {
            if (!transactions.length) return renderEmptyState('view-jurnal-umum', 'Jurnal Umum');
            const actionButtons = id => `<div class="flex items-center justify-end"><button onclick="editTransaction('${id}')" title="Edit" class="text-slate-500 hover:text-indigo-600 p-1 rounded-full transition-colors"><i data-feather="edit-2" class="w-4 h-4"></i></button><button onclick="deleteTransaction('${id}')" title="Hapus" class="text-slate-500 hover:text-red-600 p-1 rounded-full transition-colors"><i data-feather="trash-2" class="w-4 h-4"></i></button></div>`;
            const table = `<div class="overflow-x-auto"><table class="w-full text-sm">
                <thead class="bg-slate-50 text-slate-600 uppercase text-xs"><tr><th class="py-3 px-4 font-semibold text-left">Tanggal</th><th class="py-3 px-4 font-semibold text-left">Keterangan</th><th class="py-3 px-4 font-semibold text-right">Debit</th><th class="py-3 px-4 font-semibold text-right">Kredit</th><th class="py-3 px-4 font-semibold text-right">Aksi</th></tr></thead>
                <tbody>${transactions.map(tx => `<tr class="border-b bg-slate-50"><td class="py-3 px-4 font-semibold">${tx.date}</td><td class="py-2 px-4 italic" colspan="3">${tx.description}</td><td class="py-3 px-4 text-right">${actionButtons(tx.id)}</td></tr>${tx.journalEntries.map(e => `<tr class="border-b hover:bg-slate-50"><td colspan="1"></td><td class="py-2 px-4 ${e.credit>0?'pl-8':''}">${ACCOUNTS[e.accountId].name}</td><td class="py-2 px-4 text-right">${e.debit>0?formatCurrency(e.debit):''}</td><td class="py-2 px-4 text-right">${e.credit>0?formatCurrency(e.credit):''}</td><td></td></tr>`).join('')}`).join('')}</tbody></table></div>`;
            renderCard('view-jurnal-umum', 'Jurnal Umum', table);
        };
        calculateLedger = () => {
            const ledger = {};
            Object.keys(ACCOUNTS).forEach(id => { ledger[id] = { name: ACCOUNTS[id].name, type: getAccountType(id), isContra: !!ACCOUNTS[id].isContra, entries: [] }; });
            transactions.forEach(tx => tx.journalEntries.forEach(e => ledger[e.accountId].entries.push({ date: tx.date, description: tx.description, debit: e.debit, credit: e.credit }) ));
            return ledger;
        };
        renderGeneralLedger = (ledger) => {
            const activeAccounts = Object.entries(ledger).filter(([_,acc]) => acc.entries.length > 0);
            if (!activeAccounts.length) return renderEmptyState('view-buku-besar', 'Buku Besar');
            const tabs = `<div class="ledger-tabs-container"><div class="flex overflow-x-auto">${activeAccounts.map(([id, acc], index) => `<button class="ledger-tab ${index === 0 ? 'active' : ''}" data-account-id="${id}">${acc.name}</button>`).join('')}</div></div>`;
            const contents = `<div class="ledger-contents">${activeAccounts.map(([id, acc], index) => {
                let balance = 0;
                const normIsD = (['Aset','Beban'].includes(acc.type)&&!acc.isContra) || (acc.type==='Ekuitas'&&acc.isContra);
                const tableRows = acc.entries.map(e => {
                    balance += normIsD ? (e.debit - e.credit) : (e.credit - e.debit);
                    return `<tr class="border-b"><td class="p-2">${e.date}</td><td class="p-2">${e.description}</td><td class="p-2 text-right">${e.debit > 0 ? formatCurrency(e.debit) : '-'}</td><td class="p-2 text-right">${e.credit > 0 ? formatCurrency(e.credit) : '-'}</td><td class="p-2 text-right font-medium">${formatCurrency(balance)}</td></tr>`;
                }).join('');
                const totalD = acc.entries.reduce((s,e)=>s+e.debit,0), totalC = acc.entries.reduce((s,e)=>s+e.credit,0);
                return `<div class="ledger-content ${index !== 0 ? 'hidden' : ''}" data-account-id="${id}"><div class="overflow-x-auto"><table class="w-full text-sm">
                    <thead class="bg-slate-50 text-slate-600"><tr><th class="p-2 text-left">Tanggal</th><th class="p-2 text-left">Keterangan</th><th class="p-2 text-right">Debit</th><th class="p-2 text-right">Kredit</th><th class="p-2 text-right">Saldo</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                    <tfoot class="font-bold bg-slate-100"><tr><td colspan="2" class="p-2">Total</td><td class="p-2 text-right">${formatCurrency(totalD)}</td><td class="p-2 text-right">${formatCurrency(totalC)}</td><td class="p-2 text-right">${formatCurrency(balance, true)}</td></tr></tfoot>
                </table></div></div>`;
            }).join('')}</div>`;
            renderCard('view-buku-besar', 'Buku Besar', tabs + contents);
            setupLedgerTabs();
        };
        setupLedgerTabs = () => {
            const tabs = document.querySelectorAll('.ledger-tab');
            const contents = document.querySelectorAll('.ledger-content');
            if (!tabs.length) return;
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const accountId = tab.dataset.accountId;
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.add('hidden'));
                    tab.classList.add('active');
                    document.querySelector(`.ledger-content[data-account-id="${accountId}"]`).classList.remove('hidden');
                });
            });
        };
        renderTrialBalance = (ledger) => {
            let totalD=0, totalC=0, rows='';
            Object.keys(ledger).sort().forEach(id => {
                const acc = ledger[id];
                const balance = acc.entries.reduce((bal, e) => {
                    const normIsD = (['Aset','Beban'].includes(acc.type)&&!acc.isContra) || (acc.type==='Ekuitas'&&acc.isContra);
                    return bal + (normIsD ? (e.debit-e.credit) : (e.credit-e.debit));
                }, 0);
                if(balance !== 0) {
                    const normIsD = (['Aset','Beban'].includes(acc.type)&&!acc.isContra) || (acc.type==='Ekuitas'&&acc.isContra);
                    const dAmt=normIsD?balance:0, cAmt=!normIsD?balance:0;
                    totalD+=dAmt; totalC+=cAmt;
                    rows += `<tr class="border-b"><td class="py-2 px-4">${id}</td><td class="py-2 px-4">${acc.name}</td><td class="py-2 px-4 text-right">${dAmt!==0?formatCurrency(dAmt):''}</td><td class="py-2 px-4 text-right">${cAmt!==0?formatCurrency(cAmt):''}</td></tr>`;
                }
            });
            const isBalanced = Math.round(totalD) === Math.round(totalC);
            const content = `<div class="overflow-x-auto"><table class="w-full text-sm">
                <thead class="bg-slate-50 text-slate-600 uppercase text-xs"><tr><th class="py-3 px-4 text-left">No.</th><th class="py-3 px-4 text-left">Akun</th><th class="py-3 px-4 text-right">Debit</th><th class="py-3 px-4 text-right">Kredit</th></tr></thead>
                <tbody>${rows}</tbody>
                <tfoot class="font-bold"><tr class="${isBalanced?'bg-green-50 text-green-800':'bg-red-50 text-red-800'}"><td class="py-3 px-4" colspan="2">Total</td><td class="py-3 px-4 text-right">${formatCurrency(totalD,true)}</td><td class="py-3 px-4 text-right">${formatCurrency(totalC,true)}</td></tr></tfoot>
            </table><p class="text-center mt-4 font-semibold ${isBalanced?'text-green-600':'text-red-600'}">${isBalanced?'✔ Seimbang':'❌ Tidak Seimbang'}</p></div>`;
            renderCard('view-neraca-saldo', 'Neraca Saldo', content);
        };
        renderFinancialReports = (ledger) => {
            const lastDate = transactions.length ? new Intl.DateTimeFormat('id-ID',{day:'numeric',month:'long',year:'numeric'}).format(new Date(Math.max(...transactions.map(tx => new Date(tx.date))))) : '';
            const subtitle = (period) => `<p class="text-sm text-slate-500 -mt-2 mb-4">Untuk Periode ${period?'Berakhir ':''}${lastDate}</p>`;
            const calcBal = (acc) => acc.entries.reduce((bal,e)=>{
                 const normIsD = (['Aset','Beban'].includes(acc.type)&&!acc.isContra) || (acc.type==='Ekuitas'&&acc.isContra);
                 return bal + (normIsD ? (e.debit-e.credit) : (e.credit-e.debit));
            }, 0);
            const totalRev = Object.values(ledger).filter(a=>a.type==='Pendapatan').reduce((s,a)=>s+calcBal(a),0);
            const totalExp = Object.values(ledger).filter(a=>a.type==='Beban').reduce((s,a)=>s+calcBal(a),0);
            const netIncome = totalRev - totalExp;
            const initialCap = ledger['301']?.entries.reduce((s,e)=>s+e.credit-e.debit,0) || 0;
            const totalPrive = calcBal(ledger['302']);
            const finalCap = initialCap + netIncome - totalPrive;
            const totalAssets = Object.values(ledger).filter(a=>a.type==='Aset'&&!a.isContra).reduce((s,a)=>s+calcBal(a),0);
            const totalContraA = Object.values(ledger).filter(a=>a.type==='Aset'&&a.isContra).reduce((s,a)=>s+calcBal(a),0);
            const totalLiab = Object.values(ledger).filter(a=>a.type==='Liabilitas').reduce((s,a)=>s+calcBal(a),0);
            const rptRow = (label, amount, isNegative=false) => `<div class="flex justify-between"><dt>${label}</dt><dd class="${isNegative?'text-red-600':''}">${isNegative?'(':''}${formatCurrency(Math.abs(amount),true)}${isNegative?')':''}</dd></div>`;
            const lrContent = `${subtitle(true)}<div class="space-y-3 text-sm max-w-md mx-auto"><div class="font-semibold">Pendapatan</div><dl class="pl-4">${Object.values(ledger).filter(a=>a.type==='Pendapatan'&&calcBal(a)>0).map(a=>rptRow(a.name,calcBal(a))).join('')||'<div class="text-slate-500">Tidak ada.</div>'}</dl><div class="flex justify-between font-bold border-t pt-1 mt-1"><span>Total Pendapatan</span><span>${formatCurrency(totalRev,true)}</span></div><div class="font-semibold mt-4">Beban</div><dl class="pl-4">${Object.values(ledger).filter(a=>a.type==='Beban'&&calcBal(a)>0).map(a=>rptRow(a.name,calcBal(a),true)).join('')||'<div class="text-slate-500">Tidak ada.</div>'}</dl><div class="flex justify-between font-bold border-t pt-1 mt-1"><span>Total Beban</span><span class="text-red-600">(${formatCurrency(totalExp,true)})</span></div><hr class="my-3 border-t-2"><div class="flex justify-between font-bold text-base ${netIncome>=0?'text-green-700':'text-red-700'}"><span>${netIncome>=0?'Laba Bersih':'Rugi Bersih'}</span><span>${formatCurrency(Math.abs(netIncome),true)}</span></div></div>`;
            renderCard('view-laba-rugi', 'Laporan Laba Rugi', lrContent);
            const pmContent = `${subtitle(true)}<dl class="space-y-2 text-sm max-w-md mx-auto">${rptRow('Modal Awal', initialCap)}${rptRow(netIncome>=0?'Laba Bersih':'Rugi Bersih', netIncome)}${rptRow('Prive', totalPrive, true)}<hr><div class="flex justify-between font-semibold"><span>Perubahan Modal Bersih</span><span>${formatCurrency(netIncome-totalPrive,true)}</span></div><hr class="my-2 border-t-2"><div class="flex justify-between font-bold text-base mt-2"><span>Modal Akhir</span><span>${formatCurrency(finalCap,true)}</span></div></dl>`;
            renderCard('view-perubahan-modal', 'Laporan Perubahan Modal', pmContent);
            const nContent = `${subtitle(false)}<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 text-sm"><div><h4 class="font-bold border-b pb-2 mb-2">ASET</h4><dl class="space-y-2">${Object.values(ledger).filter(a=>a.type==='Aset'&&calcBal(a)!==0).map(a=>rptRow(a.name, a.isContra?-calcBal(a):calcBal(a))).join('')}</dl><div class="flex justify-between font-bold text-base mt-3 border-t-2 pt-2"><span>Total Aset</span><span>${formatCurrency(totalAssets-totalContraA,true)}</span></div></div><div class="mt-4 md:mt-0"><h4 class="font-bold border-b pb-2 mb-2">LIABILITAS & EKUITAS</h4><dl class="space-y-2"><div class="font-semibold">Liabilitas</div>${Object.values(ledger).filter(a=>a.type==='Liabilitas'&&calcBal(a)>0).map(a=>`<div class="flex justify-between pl-4"><dt>${a.name}</dt><dd>${formatCurrency(calcBal(a),true)}</dd></div>`).join('')||'<div class="pl-4 text-slate-500">Tidak ada.</div>'}<div class="font-semibold mt-2">Ekuitas</div><div class="flex justify-between pl-4"><dt>Modal Akhir</dt><dd>${formatCurrency(finalCap,true)}</dd></div></dl><div class="flex justify-between font-bold text-base mt-3 border-t-2 pt-2"><span>Total Liabilitas & Ekuitas</span><span>${formatCurrency(totalLiab+finalCap,true)}</span></div></div></div>`;
            renderCard('view-neraca', 'Laporan Neraca', nContent);
        };
        window.editTransaction = (id) => {
            const tx = transactions.find(t => t.id === id); if(!tx) return;
            openModal();
            form.querySelector('#transaction-id').value = tx.id; form.querySelector('#date').value = tx.date;
            form.querySelector('#transaction-type').value = tx.type; form.querySelector('#description').value = tx.description;
            form.querySelector('#transaction-type').dispatchEvent(new Event('change'));
            if (tx.type === 'bayar-beban') { expenseTypeSelect.value = tx.rawDetails.expenseType; }
            Object.keys(tx.rawDetails).forEach(key => {
                const inputId = `amount-${key.replace(/([A-Z])/g,'-$1').toLowerCase()}`.replace('amount-amount','amount');
                const input = document.getElementById(inputId);
                if(input) input.value = tx.rawDetails[key] > 0 ? formatCurrency(tx.rawDetails[key]) : '';
            });
        };
        window.deleteTransaction = (id) => { if(confirm('Yakin ingin menghapus transaksi ini?')){transactions = transactions.filter(tx => tx.id !== id); renderAll();} };
        setupNavigation = () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.view');
            navLinks.forEach(link => link.addEventListener('click', e => {
                e.preventDefault(); const viewId = link.dataset.view;
                navLinks.forEach(i => i.classList.remove('active')); link.classList.add('active');
                views.forEach(v => v.classList.add('hidden')); document.getElementById(`view-${viewId}`).classList.remove('hidden');
                if (window.innerWidth < 1024) closeSidebar();
            }));
        };
        populateExpenseSelect();
        setupNavigation();
        renderAll();
    };
    fullScript();
});
</script>
</body>
</html>
